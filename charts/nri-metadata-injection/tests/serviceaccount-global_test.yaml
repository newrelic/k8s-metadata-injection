suite: test ServiceAccount global values
templates:
  - templates/admission-webhooks/job-patch/serviceaccount.yaml
release:
  name: my-release
  namespace: my-namespace
tests:
  # ============================================================================
  # global.serviceAccount.create
  # ============================================================================
  - it: should create ServiceAccount when global.serviceAccount.create is true
    set:
      cluster: test-cluster
      global.serviceAccount.create: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceAccount

  - it: should not create ServiceAccount when global.serviceAccount.create is false
    set:
      cluster: test-cluster
      global.serviceAccount.create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should use local serviceAccount.create over global.serviceAccount.create
    set:
      cluster: test-cluster
      serviceAccount.create: true
      global.serviceAccount.create: false
    asserts:
      - hasDocuments:
          count: 1

  # ============================================================================
  # global.serviceAccount.name (via common-library)
  # ============================================================================
  - it: should use default ServiceAccount name when neither local nor global set
    set:
      cluster: test-cluster
      serviceAccount.create: true
    asserts:
      - equal:
          path: metadata.name
          value: my-release-nri-metadata-injection-admission
