suite: webhook
templates:
  - templates/admission-webhooks/mutatingWebhookConfiguration.yaml
release:
  name: release
  namespace: ns
tests:
  - it: sets default ignored namespaces
    set:
      cluster: my-cluster
    asserts:
      - equal:
          path: webhooks[0].namespaceSelector.matchExpressions[0].values
          value: ['kube-public', 'kube-node-lease', 'kube-system']

  - it: sets custom ignored namespaces
    set:
      cluster: my-cluster
      ignoreNamespaces: ['custom-namespace1', 'custom-namespace2']
    asserts:
      - equal:
          path: webhooks[0].namespaceSelector.matchExpressions[0].values
          value: [ 'custom-namespace1', 'custom-namespace2' ]

  - it: sets empty ignoreNamespaces results if no namespaceSelectors provided
    set:
      cluster: my-cluster
      ignoreNamespaces: []
    asserts:
      - isNull:
          path: webhooks[0].namespaceSelector

  - it: injectOnlyLabeledNamespaces=true results in namespaceSelector with matchLabels
    set:
      cluster: my-cluster
      injectOnlyLabeledNamespaces: true
    asserts:
      - equal:
          path: webhooks[0].namespaceSelector.matchLabels
          value:
            newrelic-metadata-injection: enabled
      - equal:
          path: webhooks[0].namespaceSelector.matchExpressions[0].values
          value: [ 'kube-public', 'kube-node-lease', 'kube-system' ]
