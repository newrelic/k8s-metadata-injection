suite: test ServiceAccount global annotations inheritance
templates:
  - templates/admission-webhooks/job-patch/serviceaccount.yaml
release:
  name: my-release
  namespace: my-namespace
tests:
  - it: should inherit global.serviceAccount.annotations when set
    set:
      cluster: test-cluster
      global:
        serviceAccount:
          annotations:
            eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/my-role
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: arn:aws:iam::123456789012:role/my-role
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: pre-install,pre-upgrade,post-install,post-upgrade

  - it: should merge global.serviceAccount.annotations with helm hook annotations
    set:
      cluster: test-cluster
      global:
        serviceAccount:
          annotations:
            eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/my-role
            iam.gke.io/gcp-service-account: my-sa@project.iam.gserviceaccount.com
            azure.workload.identity/client-id: "12345678-1234-1234-1234-123456789012"
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: arn:aws:iam::123456789012:role/my-role
      - equal:
          path: metadata.annotations["iam.gke.io/gcp-service-account"]
          value: my-sa@project.iam.gserviceaccount.com
      - equal:
          path: metadata.annotations["azure.workload.identity/client-id"]
          value: "12345678-1234-1234-1234-123456789012"
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: pre-install,pre-upgrade,post-install,post-upgrade
      - equal:
          path: metadata.annotations["helm.sh/hook-delete-policy"]
          value: before-hook-creation,hook-succeeded
