suite: serviceAccount
templates:
  - templates/admission-webhooks/job-patch/serviceaccount.yaml
release:
  name: my-release
  namespace: my-namespace
tests:
  - it: should use default ServiceAccount name when neither local nor global set
    set:
      cluster: test-cluster
    asserts:
      - equal:
          path: metadata.name
          value: my-release-nri-metadata-injection-admission

  - it: should create ServiceAccount when global.serviceAccount.create is true
    set:
      cluster: test-cluster
      global.serviceAccount.create: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceAccount

  - it: should not create ServiceAccount when global.serviceAccount.create is false
    set:
      cluster: test-cluster
      global.serviceAccount.create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should use local serviceAccount.create over global.serviceAccount.create
    set:
      cluster: test-cluster
      serviceAccount.create: true
      global.serviceAccount.create: false
    asserts:
      - hasDocuments:
          count: 1

  - it: should inherit global.serviceAccount.annotations when set
    set:
      cluster: test-cluster
      global:
        serviceAccount:
          annotations:
            eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/my-role
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: arn:aws:iam::123456789012:role/my-role
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: pre-install,pre-upgrade,post-install,post-upgrade

  - it: should merge global.serviceAccount.annotations with helm hook annotations
    set:
      cluster: test-cluster
      global:
        serviceAccount:
          annotations:
            eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/my-role
            iam.gke.io/gcp-service-account: my-sa@project.iam.gserviceaccount.com
            azure.workload.identity/client-id: "12345678-1234-1234-1234-123456789012"
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: arn:aws:iam::123456789012:role/my-role
      - equal:
          path: metadata.annotations["iam.gke.io/gcp-service-account"]
          value: my-sa@project.iam.gserviceaccount.com
      - equal:
          path: metadata.annotations["azure.workload.identity/client-id"]
          value: "12345678-1234-1234-1234-123456789012"
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: pre-install,pre-upgrade,post-install,post-upgrade
      - equal:
          path: metadata.annotations["helm.sh/hook-delete-policy"]
          value: before-hook-creation,hook-succeeded
